<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.newtouch.buglifecycle.dao.UnsolvedBugDetialDao">

    <resultMap id="BaseResultMap"
        type="com.newtouch.buglifecycle.entity.home.UnsolvedBugDetialVO">
        <result column="ID" property="id" jdbcType="VARCHAR" />
        <result column="PROJECTNAME" property="projectName" jdbcType="VARCHAR" />
        <result column="PUTHOURS" property="putHours" jdbcType="VARCHAR" />
        <result column="TYPE" property="type" jdbcType="VARCHAR" />
        <result column="TITLE" property="title" jdbcType="VARCHAR" />
        <result column="OPENEDBY" property="openedBy" jdbcType="VARCHAR" />
        <result column="ASSIGNEDTO" property="assignedTo" jdbcType="VARCHAR" />
        <result column="RESOLVEDBY" property="resolvedBy" jdbcType="VARCHAR" />
        <result column="RESOLUTION" property="resolution" jdbcType="VARCHAR" />
    </resultMap>

    <select id="findAll" resultMap="BaseResultMap">
        SELECT
        a.id as id,
        b.name as projectName,
        TIMESTAMPDIFF(hour,a.openedDate,now()) as putHours,
        a.type as type,
        a.title as title,
        d.realname as openedBy,
        e.realname as assignedTo,
        f.realname as resolvedBy,
        a.resolution as resolution
        FROM
        zt_bug a
        LEFT JOIN
        zt_product b
        ON
        a.product = b.id
        LEFT JOIN
        zt_project c
        ON
        a.project = c.id
        LEFT JOIN
        zt_user d
        ON
        a.openedBy = d.account
        LEFT JOIN
        zt_user e
        ON
        a.assignedTo = e.account
        LEFT JOIN
        zt_user f
        ON
        a.resolvedBy = f.account
        WHERE
        1=1
        <choose>
            <when test="versionId!=null and versionId!=''">
                AND
                c.id = #{version}
            </when>
            <otherwise>
                AND
                c.name like '%'||(select right(YEAR (CURDATE()),2))
            </otherwise>
        </choose>
        <if test="systemId!=null and systemId!=''">
            AND  b.id = #{systemId}
        </if>
        AND
        a.status = 'active'
        AND
        a.type = 'redev'
        ORDER BY
        id
        DESC
    </select>

    <select id="findBugDetail" resultMap="BaseResultMap">
        SELECT
            a.id as id,
            b.name as projectName,
            TIMESTAMPDIFF(hour,a.openedDate,now()) as putHours,
            a.type as type,
            a.title as title,
            d.realname as openedBy,
            e.realname as assignedTo,
            f.realname as resolvedBy,
            a.resolution as resolution
        FROM
            zt_bug a
        LEFT JOIN
            zt_product b
        ON
            a.product = b.id
        LEFT JOIN
            zt_project c
        ON
            a.project = c.id
        LEFT JOIN
            zt_user d
        ON
            a.openedBy = d.account
        LEFT JOIN
            zt_user e
        ON
            a.assignedTo = e.account
        LEFT JOIN
            zt_user f
        ON
            a.resolvedBy = f.account
        WHERE
            1=1
        <if test="storyId!=null and storyId!=''">
            AND a.story = #{storyId}
        </if>
    </select>



    <select id="findBugDetailPage" resultMap="BaseResultMap">
        SELECT
        a.id as id,
        b.name as projectName,
        TIMESTAMPDIFF(hour,a.openedDate,now()) as putHours,
        a.type as type,
        a.title as title,
        d.realname as openedBy,
        e.realname as assignedTo,
        f.realname as resolvedBy,
        a.resolution as resolution
        FROM
        zt_bug a
        LEFT JOIN
        zt_product b
        ON
        a.product = b.id
        LEFT JOIN
        zt_project c
        ON
        a.project = c.id
        LEFT JOIN
        zt_user d
        ON
        a.openedBy = d.account
        LEFT JOIN
        zt_user e
        ON
        a.assignedTo = e.account
        LEFT JOIN
        zt_user f
        ON
        a.resolvedBy = f.account
        WHERE
        1=1
        <if test="systemVO.storyId!=null and systemVO.storyId!=''">
            AND a.story = #{systemVO.storyId}
        </if>
        limit #{page.minNum},#{page.pageSize}

    </select>

</mapper>
